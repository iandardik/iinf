\documentclass[12pt]{article}
\usepackage{anysize}
\marginsize{1.2cm}{1.4cm}{.4cm}{1cm}

\usepackage[normalem]{ulem}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{hyperref}
\usepackage{amsthm}
\usepackage{url}
\usepackage{hyperref}

\theoremstyle{definition}
\newtheorem{assumption}{Assumption}
\newtheorem{lemma}{Lemma}
\newtheorem{corollary}{Corollary}
\newtheorem{theorem}{Theorem}
\newtheorem{definition}{Definition}
\newtheorem{example}{Example}

\theoremstyle{remark}
\newtheorem{remark}{Remark}

\newcommand{\msp}{\text{ }}
\newcommand{\states}{\text{States}}
\newcommand{\gr}{\text{Gr}}
\newcommand{\fips}{\text{FIPS}}
\newcommand{\perm}{\genfrac{}{}{0pt}{}}

\title{A Cutoff Rule For Parameterized Distributed Protocols in Prenex Normal Form}
\author{Ian Dardik}
\date{\today}


\begin{document}

\maketitle

\section{Introduction}
In this note, we consider the verification problem of a transition system $T=(I,\Delta)$ parameterized by a single sort $P$ of identical elements.  We assume that a candidate inductive invariant $\Phi$ (which implies our key safety property) is given.  $\Phi$ universally quantifies over one or more variables, $\Delta$ (the transition relation) exitentially quantifies over one or more variables, and and both $\Phi$ and $\Delta$ are in Prenex Normal Form (PNF).  We adopt the convention of \cite{goel2021symmetry} where $T(P)$ is the template of $T$, and $T(|P|)$ is a finite instantiation.  We also will consider the prime (') symbol to be an operator that can be recursively applied to a formula, only affecting (sticking to) state variables.

In this note, we will build several lemmas that lead to an interesting result: $\Phi(P)$ is an inductive invariant for $T(P)$ iff $\Phi(m+n)$ is an inductive invariant for $T(m+n)$, where $m$ is the number of variables that $\Phi$ quantifies over and $n$ is the number of variables that $\Delta$ quantifies over.  This result is useful for the verification problem laid out above because it reduces the burden to model checking the single finite instance $T(m+n)$.  Essentially, $m+n$ is a cutoff instance size for proving that our inductive invariant holds.



\section{Preliminaries}
In this section we cover several preliminary items that we use to prove the MN Theorem.

\subsection{Without Loss Of Generality}
We will assume that the parameter $P = \{1,...,|P|\}$.  This assumption comes without loss of generality because each member of $P$ is assumed to be identical.  We make the notion of ``identical" precise in Assumption \ref{asmp:ident}.

\subsection{Assumptions}
This section contains the list of assumptions for the transition system we work with.  In other words, these assumptions are the requirements for the M-N Theorem to hold.

\begin{assumption}[$P$ Has Identical Elements]
  \label{asmp:ident}
  Let $s$ be a state, $f$ be a grounded formula, and $g$ be a permutation.  Then we assume that:
  $$(s \models f) \leftrightarrow (g(s) \models g(f))$$
\end{assumption}

\subsection{Definitions}
\begin{definition}[States]
  Let $k \in \mathbb{N}$, then:
  $$\states(k) := \{\text{all states when } |P|=k\}$$
\end{definition}

\begin{definition}[Ground Formulas]
  Let $F$ be a quantified formula and $k \in \mathbb{N}$.
  $$\gr(F,k) := \{f | (f \text{ is a ground formula of } F(k)) \land (f \models F(k))\}$$
\end{definition}

\begin{example}
  $\gr((\forall p,q, p=q),2) := \{(1=1),(2=2)\}$
\end{example}
\begin{example}
  $\gr((\forall p,q, p \neq q),3) := \{(1 \neq 2),(1 \neq 3),(2 \neq 1),(2 \neq 3),(3 \neq 1),(3 \neq 2)\}$
\end{example}



\section{MN}
\begin{theorem}[M-N]
  Suppose that $\Phi$ is in PNF with only universal quantifiers, while $\Delta$ is in PNF with only existential quantifiers.  Let $m$ be the number of variables that $\Phi$ quantifies over and $n$ be the number of variables that $\Delta$ quantifies over.  If $\Phi(m+n)$ is an inductive invariant, then $\Phi(k)$ is also an inductive invariant for any $k>m+n$.
\end{theorem}
\begin{proof}
  Let $k>m+n$ be given and assume that $[\Phi\land\Delta \rightarrow \Phi'](m+n)$ is valid.  Let $s \in \states(k)$ such that $s \models \Phi(k)$, and let $\delta$ be the next transition, i.e. $\delta \models \Delta(k)$.  Finally, let $f' \in \gr(\Phi',k)$ be arbitrary, then we must show that $(s \land \delta) \models f'$.

  Next, let $g$ be a permutation such that $g(\delta) \models \Delta(m+n)$ and $g(f') \in \gr(\Phi',m+n)$, i.e. $g(f') \models \Phi'(m+n)$.  We know that we can find such a $g$ because $\delta$ will contain at most $n$ distinct elements of $P$ and $f'$ will contain at most $m$ distinct elements of $P$.  Notice that $\gr(\Phi,m+n) \subset \gr(\Phi,k)$ so $s \models \Phi(m+n)$, and furthermore $g(s) \models \Phi(m+n)$.  Thus $g(s \land \delta) \models \Phi'(m+n)$, and in particular, $g(s \land \delta) \models g(f')$.  Therefore $s \land \delta \models f'$ by Assumption \ref{asmp:ident}.
\end{proof}



\section{Case Studies}
In this section we visit several (more coming soon) distributed protocols that are parameterized by a single sort and adhere to the property of Assumption \ref{asmp:ident}.

\subsection{Peterson's Mutex Protocol}
Peterson's Mutex Protocol can be encoded with a transition function $\Delta$ in PNF that quantifies over two variables.  A sample inductive invariant candidate is given in \cite{ian-peterson} that quantifies of two variables and works for $|P|=2$:
\begin{verbatim}
    Phi == \A p,q \in ProcSet :
       /\ pc[p] \in {"a3","a4","cs"} => flag[p]
       /\ (p#q /\ pc[p] = "cs" /\ pc[q] = "a4") => turn = p
       /\ (p # q) => ~(pc[p] = "cs" /\ pc[q] = "cs")
\end{verbatim}
However, by the M-N Theorem, we must show that $\Phi$ is an inductive invariant for the case when $|P|=4$.  In fact, we easily see that $\Phi$ fails to be inductive in the case:
\begin{verbatim}
                      /\ turn = 1             /\ turn = 2
                      /\ pc[1] = "cs"         /\ pc[1] = "cs"
                      /\ pc[2] = "a4"   ->    /\ pc[2] = "a4"
                      /\ pc[3] = "a3"         /\ pc[3] = "a4"
                      /\ a3(3,2)
\end{verbatim}
This example uses states to describe the counterexample, but we can also describe it using the FIP $M_{\Phi}(1,2) \land M_{\Delta}(3,2)$ from $[\Phi\land\Delta](4)$.  When this FIP is true, both $M_{\Phi}(1,2)$ and $M_{\Phi}(1,3)$ fail to hold in the next state, showing that $M_{\Phi}(1,2)$--and hence $\Phi$--is not inductive.

This example shows how a FIP describes a specific relationship between $\Phi$ and $\Delta$; in this case the specific relationship leads to a counterexample.  It is important to note that it is only possible to describe this particular counterexample using a FIP with a minimum of three elements in $P$, which is precisely why we do not detect the counter example in Peterson's Protocol when $|P|=2$.

It is also worthwhile to note that we could derive the same counterexample using an equivalent FIP, say $M_{\Phi}(3,2) \land M_{\Delta}(1,2)$.  This shows how FIP equivalency partitions a formula $\Phi\land\Delta$ into classes of specific relationships that a transition system can exhibit.


\bibliographystyle{plain}
\bibliography{refs}

\end{document}
